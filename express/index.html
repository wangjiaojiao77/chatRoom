<!DOCTYPE html><html><head>
<meta charset="UTF-8">
<title>聊天室</title>
<style>
body,div,ul,li{margin: 0;padding: 0;list-style: none;}
body{color: #fff;}
.auto{margin: auto;}
.l{text-align: left;}
.r{text-align: right;}
.flex{display: box;display: -webkit-box;display: -moz-box;display: -ms-flexbox;display: -webkit-flex;display: flex;-webkit-box-pack: center;-webkit-justify-content: center;-moz-justify-content: center;-ms-justify-content: center;-o-justify-content: center;justify-content: center;-webkit-box-align: center;-webkit-align-items: center;-moz-align-items: center;-ms-align-items: center;-o-align-items: center;align-items: center;}
.list{position:relative;width: 40vw;padding:1vw 2vw;height:30vw;border:1px solid #ccc;margin-top: 2vw;}
.wrapper{width: 100%;height: 100%;overflow: hidden;position: relative;z-index: 2;}
.chat-box{width: 100%;}
.chat-box li{margin-bottom: 8px;}
.chat-li{text-align:left;max-width:78%;display:inline-block;background: #5CB85C;border-radius: 5px;padding: 3px 10px;color: #fff;}
.other-chat-li{background: #fff;color: #333;}
.send-box{position:relative;z-index:2;width: 44vw;border:1px solid #ccc;justify-content: space-between;border-top: 0;}
.send-text{width: 36vw; border: none; padding: 11px;outline:0;}
.send{width: 8vw;background: #5cb85c; border: none; padding: 10px;color: #fff;cursor: pointer;}
.other-box,.self-box{width: 50%;height:100%;}
.prompt{text-align: center;font-size: 10px;}
.username-l{display: inline-block;font-size: 12px;margin-right: 5px;vertical-align:top;margin-top: 2px;}
.username-r{display: inline-block;font-size: 12px;margin-left: 5px;vertical-align:top;margin-top: 2px;}
.con{position: absolute;left: 30vw;top: 0;}
#mainCanvas{width: 100%;height: 100%;}
</style>
</head>
<body>
	<div id="outer">
		<div id="canvasContainer">
			<canvas id="mainCanvas" width="1000" height="560"></canvas>
			<div id="output"></div>
		</div>
	</div>

	<div class="con">
		<div class="list auto">
	    	<!--<canvas id="canvas-club"></canvas>-->
	        <div class="auto wrapper">
	            <ul class="chat-box"></ul>
	        </div>
	    </div>
	    <div class="flex send-box auto">
	        <input class="send-text" type="text">
	        <button class="send" type="button">发送</button>
	    </div>
	</div>

</body>
<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script src="https://qiniustatic.wodidashi.com/iscroll/iscroll-lite.js"></script>
<script>
    $(function(){
        var socket = io(),
            myScroll, titleFlag;

        var num = parseInt(Math.random()*100000),
            username = '观众'+num+'';

        socket.emit('join', {
            username: username
        });

        document.addEventListener('visibilitychange',function(e){
			e = e || event;
			var hide = e.target.hidden;
			if(hide){
				pageHide = true;
			}else{
				pageHide = false;
				document.title = '聊天室';
				clearInterval(titleFlag);
			}
		})

        socket.on('broadcast_join', function (data) {
            $('.chat-box').append('<li class="prompt">'+ data.username + '加入了聊天室</li>');
            scroll();
        });

        socket.on('broadcast_quit', function(data) {
            $('.chat-box').append('<li class="prompt">'+ data.username + '离开了聊天室</li>');
            scroll();
        });

        socket.on('broadcast_say', function(data) {
        	document.title = "新消息";
        	titleFlag = setInterval(function(){
				if(document.title == "新消息"){
					document.title = ".";
				}else{
					document.title = "新消息"
				}
        	},1)
            $('.chat-box').append('<li class="l"><span class="username-l">'+data.username+'</span><span class="chat-li other-chat-li">'+ data.text +'</span></li>');
            scroll();
        });

        $(".send").click(function(){
            var msg = $(".send-text").val();
            if(msg != ""){
                socket.emit('say', {
                    username: username,
                    text: msg
                });
                $('.chat-box').append('<li class="r"><span class="chat-li">'+ msg +'</span><span class="username-r">'+username+'</span></li>');
                $(".send-text").val("");

                scroll();
            }else{
                return false;
            }
        })

        $(".send-text").keydown(function(event){
            if(event.keyCode == 13){
                var msg = $(".send-text").val();
                if(msg != ""){
                    socket.emit('say', {
                        username: username,
                        text: msg
                    });
                    $('.chat-box').append('<li class="r"><span class="chat-li">'+ msg +'</span><span class="username-r">'+username+'</span></li>');
                    $(".send-text").val("");

                    scroll();
                }else{
                    return false;
                }
            }
        })
    })

    function scroll(){
        if($(".chat-box").height() > $(".wrapper").height()){
            myScroll = new IScroll('.wrapper',{
                mouseWheel: true
            });
            myScroll.refresh();
            myScroll.scrollToElement($(".chat-box")[0].lastChild,0,0,-1);
    	}
    }
</script>
<script>
	(function(){
	function C(){
		e.globalCompositeOperation="source-over";
		e.fillStyle="rgba(8,8,12,0.65)";
		e.fillRect(0,0,f,p);
		e.globalCompositeOperation="lighter";
		x=q-u;
		y=r-v;
		u=q;
		v=r;
		for(var d=0.86*f,l=0.125*f,m=0.5*f,t=Math.random,n=Math.abs,o=z;o--;){
			var h=A[o],i=h.x,j=h.y,a=h.a,b=h.b,c=i-q,k=j-r,g=Math.sqrt(c*c+k*k)||0.001,c=c/g,k=k/g;
			if(w&&g<m)
			var s=14*(1-g/m),a=a+(c*s+0.5-t()),b=b+(k*s+0.5-t());
			g<d&&(s=0.0014*(1-g/d)*f,a-=c*s,b-=k*s);
			g<l&&(c=2.6E-4*(1-g/l)*f,a+=x*c,b+=y*c);
			a*=B;
			b*=B;
			c=n(a);
			k=n(b);
			g=0.5*(c+k);
			0.1>c&&(a*=3*t());
			0.1>k&&(b*=3*t());
			c=0.45*g;
			c=Math.max(Math.min(c,3.5),0.4);
			i+=a;
			j+=b;
			i>f?(i=f,a*=-1):0>i&&(i=0,a*=-1);
			j>p?(j=p,b*=-1):0>j&&(j=0,b*=-1);
			h.a=a;
			h.b=b;
			h.x=i;
			h.y=j;
			e.fillStyle=h.color;
			e.beginPath();
			e.arc(i,j,c,0,D,!0);
			e.closePath();
			e.fill()
		}
	}
	function E(d){
		d=d?d:window.event;
		q=d.clientX-m.offsetLeft-n.offsetLeft;
		r=d.clientY-m.offsetTop-n.offsetTop
	}
	function F(){
		w=!0;
		return!1
	}
	function G(){
		return w=!1
	}
	function H(){
		this.color="rgb("+Math.floor(255*Math.random())+","+Math.floor(255*Math.random())+","+Math.floor(255*Math.random())+")";
		this.b=this.a=this.x=this.y=0;
		this.size=1
	}
	var D=2*Math.PI,f=1E3,p=560,z=600,B=0.96,A=[],o,e,n,m,q,r,x,y,u,v,w;
	window.onload=function(){
		o=document.getElementById("mainCanvas");
		if(o.getContext){
			m=document.getElementById("outer");
			n=document.getElementById("canvasContainer");
			e=o.getContext("2d");
			for(var d=z;d--;){
				var l=new H;
				l.x=0.5*f;
				l.y=0.5*p;
				l.a=34*Math.cos(d)*Math.random();
				l.b=34*Math.sin(d)*Math.random();
				A[d]=l}q=u=0.5*f;r=v=0.5*p;
				document.getElementById("canvasContainer").onmousedown=F;
				document.getElementById("canvasContainer").onmouseup=G;
				document.getElementById("canvasContainer").onmousemove=E;
				setInterval(C,33);
				document.getElementById("output").innerHTML='用鼠标进行滑动或点击'
			}
		else document.getElementById("output").innerHTML="对不起，需要最新版本的Chrome, Firefox, Opera, Safari, or Internet Explorer 9."
	}
})();
</script>
<!--<script>
	var c = document.getElementById("canvas-club");
var ctx = c.getContext("2d");
var w = c.width = $(".list").width();
var h = c.height = $(".list").height();
var clearColor = 'rgba(0, 0, 0, .1)';
var max = 20;
var drops = [];

function random(min, max) {
    return Math.random() * (max - min) + min;
}

function O() {}

O.prototype = {
	init: function() {
		this.x = random(0, w);
		this.y = 0;
		this.color = 'hsl(180, 100%, 50%)';
		this.w = 2;
		this.h = 1;
		this.vy = random(4, 5);
		this.vw = 3;
		this.vh = 1;
		this.size = 2;
		this.hit = random(h * .8, h * .9);
		this.a = 1;
		this.va = .96;
	},
	draw: function() {
		if (this.y > this.hit) {
			ctx.beginPath();
			ctx.moveTo(this.x, this.y - this.h / 2);

			ctx.bezierCurveTo(
				this.x + this.w / 2, this.y - this.h / 2,
				this.x + this.w / 2, this.y + this.h / 2,
				this.x, this.y + this.h / 2);

			ctx.bezierCurveTo(
				this.x - this.w / 2, this.y + this.h / 2,
				this.x - this.w / 2, this.y - this.h / 2,
				this.x, this.y - this.h / 2);

			ctx.strokeStyle = 'hsla(180, 100%, 50%, '+this.a+')';
			ctx.stroke();
			ctx.closePath();

		} else {
			ctx.fillStyle = this.color;
			ctx.fillRect(this.x, this.y, this.size, this.size * 5);
		}
		this.update();
	},
	update: function() {
		if(this.y < this.hit){
			this.y += this.vy;
		} else {
			if(this.a > .03){
				this.w += this.vw;
				this.h += this.vh;
				if(this.w > 100){
					this.a *= this.va;
					this.vw *= .98;
					this.vh *= .98;
				}
			} else {
				this.init();
			}
		}

	}
}

function resize(){
	w = c.width = window.innerWidth;
	h = c.height = window.innerHeight;
}

function setup(){
	for(var i = 0; i < max; i++){
		(function(j){
			setTimeout(function(){
				var o = new O();
				o.init();
				drops.push(o);
			}, j * 5000)
		}(i));
	}
}


function anim() {
	ctx.fillStyle = clearColor;
	ctx.fillRect(0,0,w,h);
	for(var i in drops){
		drops[i].draw();
	}
	requestAnimationFrame(anim);
}


window.addEventListener("resize", resize);

setup();
anim();
</script>-->
</html>
